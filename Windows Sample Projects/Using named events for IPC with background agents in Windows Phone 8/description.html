<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,1:ImageSprite;/Areas/Epx/Themes/Msdn/Content:0,/Areas/Epx/Content/Css:1&amp;amp;hashKey=E7560C71640616C5057FAEACB58DCB00" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/2f95808e-ca34-4249-88ff-44fabe33cdc0Combined.css,1:LinkList,2:ImageSprite,2:SiteFeedbackLink;/Areas/Epx/Themes/Msdn/Content:0,/Areas/Epx/Themes/Base/Content:1,/Areas/Epx/Content/Css:2&amp;amp;hashKey=EEE39C2D6B93379FDAF50337BE99AF8C" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Using named events for IPC with background agents in Windows Phone 8</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Using named events for IPC with background agents in Windows Phone 8</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Win32, Windows Phone, Windows Phone SDK 7.1, Windows Phone 8
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Asynchronous Programming, threading, Phone application development, Synchronization<wbr />, Background Agent
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Phone
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary Language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Last Updated</label>
                    <div id="LastUpdated">3/27/2013</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">MS-LPL</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/Using-named-events-for-IPC-133e5bf9">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy Code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<h1>Introduction</h1>
<p>This sample shows how to use Win32 Named Events in a Windows Phone 8 application, primarily to coordinate work between a foreground application and its background agent.</p>
<h1><span>Building the Sample</span></h1>
<p>The solution should build and run as-is. Pressing F5 should start the foreground application in the Windows Phone emulator.</p>
<p><span style="font-size:20px; font-weight:bold">Description</span></p>
<p>This sample uses the new Windows Phone Runtime Component project type in Windows Phone 8 to wrap the Win32 Event APIs in a C&#43;&#43; class that is easily callable from C#. The class enables you to create new named events or open existing named events. Events can
 be Set and Reset in order to signal other threads or processes that something interesting has happened. When waiting for an event to be signalled, this sample uses the new 'awaitable' pattern rather than blocking the thread (which is what the underlying Win32
 WaitForSingleObjectEx API does). This enables you to 'wait' on events from your UI thread without actually blocking further interaction with the UI.</p>
<p>The sample also provides a wrapper for using .NET style event handlers rather than explicitly waiting on the event object to be signalled. Either approach can be used, depending on the intended purpose and your preference.</p>
<p>&nbsp;</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">// Loop termination condition; it would be set to
// false in another part of the code once this loop 
// is expected to terminate
bool acceptingData;

private void StartAcceptingData()
{
  // Open the event named &quot;data_ready&quot; that has 
  // already been created
  // (will throw if the event doesn't exist)
  var dataReady = new NamedEvent(&quot;data_ready&quot;);

  // Start accepting data. Someone else will 
  // set this to false later on
  acceptingData = true;

  ThreadPool.QueueUserWorkItem(new WaitCallback(
  async delegate
  {
    // Loop runs forever until it is told to stop
    while (acceptingData)
    {
      // First, wait for the event to be signalled
      await dataReady.WaitAsync();

      // Check if we were asked to stop while we 
      // were waiting, and if so bail out
      if (!acceptingData)
        break;

      // Now do something with the data...
    }

    // Loop terminated since we were told to stop 
    dataReady.Dispose();
  } // delegate
  ) // new WaitCallback
  ); // QueueUserWorkItem
}
</pre>
<div class="preview">
<pre class="csharp"><span class="cs__com">//&nbsp;Loop&nbsp;termination&nbsp;condition;&nbsp;it&nbsp;would&nbsp;be&nbsp;set&nbsp;to</span>&nbsp;
<span class="cs__com">//&nbsp;false&nbsp;in&nbsp;another&nbsp;part&nbsp;of&nbsp;the&nbsp;code&nbsp;once&nbsp;this&nbsp;loop&nbsp;</span>&nbsp;
<span class="cs__com">//&nbsp;is&nbsp;expected&nbsp;to&nbsp;terminate</span>&nbsp;
<span class="cs__keyword">bool</span>&nbsp;acceptingData;&nbsp;
&nbsp;
<span class="cs__keyword">private</span>&nbsp;<span class="cs__keyword">void</span>&nbsp;StartAcceptingData()&nbsp;
{&nbsp;
&nbsp;&nbsp;<span class="cs__com">//&nbsp;Open&nbsp;the&nbsp;event&nbsp;named&nbsp;&quot;data_ready&quot;&nbsp;that&nbsp;has&nbsp;</span>&nbsp;
&nbsp;&nbsp;<span class="cs__com">//&nbsp;already&nbsp;been&nbsp;created</span>&nbsp;
&nbsp;&nbsp;<span class="cs__com">//&nbsp;(will&nbsp;throw&nbsp;if&nbsp;the&nbsp;event&nbsp;doesn't&nbsp;exist)</span>&nbsp;
&nbsp;&nbsp;var&nbsp;dataReady&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;NamedEvent(<span class="cs__string">&quot;data_ready&quot;</span>);&nbsp;
&nbsp;
&nbsp;&nbsp;<span class="cs__com">//&nbsp;Start&nbsp;accepting&nbsp;data.&nbsp;Someone&nbsp;else&nbsp;will&nbsp;</span>&nbsp;
&nbsp;&nbsp;<span class="cs__com">//&nbsp;set&nbsp;this&nbsp;to&nbsp;false&nbsp;later&nbsp;on</span>&nbsp;
&nbsp;&nbsp;acceptingData&nbsp;=&nbsp;<span class="cs__keyword">true</span>;&nbsp;
&nbsp;
&nbsp;&nbsp;ThreadPool.QueueUserWorkItem(<span class="cs__keyword">new</span>&nbsp;WaitCallback(&nbsp;
&nbsp;&nbsp;async&nbsp;<span class="cs__keyword">delegate</span>&nbsp;
&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//&nbsp;Loop&nbsp;runs&nbsp;forever&nbsp;until&nbsp;it&nbsp;is&nbsp;told&nbsp;to&nbsp;stop</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">while</span>&nbsp;(acceptingData)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//&nbsp;First,&nbsp;wait&nbsp;for&nbsp;the&nbsp;event&nbsp;to&nbsp;be&nbsp;signalled</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;await&nbsp;dataReady.WaitAsync();&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//&nbsp;Check&nbsp;if&nbsp;we&nbsp;were&nbsp;asked&nbsp;to&nbsp;stop&nbsp;while&nbsp;we&nbsp;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//&nbsp;were&nbsp;waiting,&nbsp;and&nbsp;if&nbsp;so&nbsp;bail&nbsp;out</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">if</span>&nbsp;(!acceptingData)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">break</span>;&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//&nbsp;Now&nbsp;do&nbsp;something&nbsp;with&nbsp;the&nbsp;data...</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//&nbsp;Loop&nbsp;terminated&nbsp;since&nbsp;we&nbsp;were&nbsp;told&nbsp;to&nbsp;stop&nbsp;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;dataReady.Dispose();&nbsp;
&nbsp;&nbsp;}&nbsp;<span class="cs__com">//&nbsp;delegate</span>&nbsp;
&nbsp;&nbsp;)&nbsp;<span class="cs__com">//&nbsp;new&nbsp;WaitCallback</span>&nbsp;
&nbsp;&nbsp;);&nbsp;<span class="cs__com">//&nbsp;QueueUserWorkItem</span>&nbsp;
}&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p>&nbsp;</p>
<h1><span>Source Code Files</span></h1>
<ul>
<li>IpcWrapper\NamedEvent.h and .cpp implement the Windows Phone Runtime component<em></em>
</li><li>Win32NamedEventTest\NamedEventHelper.cs implements the .NET event wrapper </li><li>Other files are normal Windows Phone application and background agent files </li></ul>
<h1>More Information</h1>
<p>A blog post on the Windows Phone Developer Blog goes into more details about this sample. You can find the blog post
<a href="http://blogs.windows.com/windows_phone/b/wpdev/archive/2013/03/27/using-named-events-to-coordinate-foreground-apps-and-background-agents.aspx">
here</a>.</p>

</div>


    </div>
</body>
</html>
